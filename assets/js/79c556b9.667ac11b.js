"use strict";(self.webpackChunksite_generator_docusaurus=self.webpackChunksite_generator_docusaurus||[]).push([[5289],{27391:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"integration-guide/saml/microsoft-entra","title":"MS Entra Integration","description":"This directory contains scripts for integrating with Microsoft Entra ID (formerly Azure Active Directory), including domain federation setup.","source":"@site/../01-pages/04-integration-guide/01-saml/01-microsoft-entra.md","sourceDirName":"04-integration-guide/01-saml","slug":"/integration-guide/saml/microsoft-entra","permalink":"/integration-guide/saml/microsoft-entra","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":1,"frontMatter":{},"sidebar":"integrationGuideSidebar","next":{"title":"AWS Cognito","permalink":"/integration-guide/saml/aws-cognito"}}');var t=i(74848),o=i(28453);const a={},s="MS Entra Integration",c={},l=[{value:"Domain Federation Setup",id:"domain-federation-setup",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Configuration",id:"configuration",level:3},{value:"Running the Script",id:"running-the-script",level:3},{value:"Auto-Acceleration",id:"auto-acceleration",level:4},{value:"Domain Verification",id:"domain-verification",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Incorrect issuer / sign uri",id:"incorrect-issuer--sign-uri",level:3},{value:"Authentication Issues",id:"authentication-issues",level:3}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"ms-entra-integration",children:"MS Entra Integration"})}),"\n",(0,t.jsx)(n.p,{children:"This directory contains scripts for integrating with Microsoft Entra ID (formerly Azure Active Directory), including domain federation setup."}),"\n",(0,t.jsx)(n.h2,{id:"domain-federation-setup",children:"Domain Federation Setup"}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"create-domain-federation.ps1"})," script automates the process of:"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Creating a custom domain in Microsoft Entra ID"}),"\n",(0,t.jsx)(n.li,{children:"Verifying domain ownership via DNS records"}),"\n",(0,t.jsx)(n.li,{children:"Setting up SAML federation for the domain"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"PowerShell Core (pwsh) 7.0 or higher"}),"\n",(0,t.jsx)(n.li,{children:"Microsoft Graph PowerShell module installed"}),"\n",(0,t.jsx)(n.li,{children:"Appropriate permissions in Microsoft Entra ID"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"To install the required PowerShell module:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-powershell",children:"Install-Module Microsoft.Graph -Scope CurrentUser\n"})}),"\n",(0,t.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsx)(n.p,{children:"Before running the script, you need to create a configuration file for your environment:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Create a configuration file named ",(0,t.jsx)(n.code,{children:"config.<environment>.ps1"})," in the ",(0,t.jsx)(n.code,{children:"env"}),"\ndirectory:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"touch backend/identity/iam/ms-entra/env/config.<environment>.ps1\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Add the following content to your configuration file, replacing the values\nwith your own:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-powershell",children:'# Microsoft Entra ID tenant ID\n$TenantId = "your-tenant-id"\n\n# Domain to create and federate\n$DomainName = "yourdomain.com"\n\n# Base64-encoded X.509 certificate for SAML signing\n$SigningCertificate = "MIIDXTCCAkWgAwIBAgI..."\n'})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Notes:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["TenantId can be found in MS Entra admin\nconsole: ",(0,t.jsx)(n.a,{href:"https://entra.microsoft.com/#settings/directory",children:"https://entra.microsoft.com/#settings/directory"}),", and select the\ndirectory id of the user directory you want to federate."]}),"\n",(0,t.jsxs)(n.li,{children:["DomainName should be the domain for which you define users (e.g.\n",(0,t.jsx)(n.a,{href:"mailto:your.user@yourdomain.com",children:"your.user@yourdomain.com"}),")"]}),"\n",(0,t.jsxs)(n.li,{children:["Vouch Identity must be hosted such that ",(0,t.jsx)(n.a,{href:"https://sso.yourdomain.com",children:"https://sso.yourdomain.com"})," serves the\nbackend"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"running-the-script",children:"Running the Script"}),"\n",(0,t.jsx)(n.p,{children:"To run the script:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Run the script with your environment configuration\n./create-domain-federation.ps1 -Environment <environment>\n"})}),"\n",(0,t.jsx)(n.p,{children:"The script will:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Connect to Microsoft Graph API"}),"\n",(0,t.jsx)(n.li,{children:"Check if the domain exists"}),"\n",(0,t.jsx)(n.li,{children:"Create the domain if it doesn't exist"}),"\n",(0,t.jsx)(n.li,{children:"Verify domain ownership (requires DNS record creation)"}),"\n",(0,t.jsx)(n.li,{children:"Set up or update federation configuration"}),"\n",(0,t.jsx)(n.li,{children:"Configure sign-in auto-acceleration for applications"}),"\n"]}),"\n",(0,t.jsx)(n.h4,{id:"auto-acceleration",children:"Auto-Acceleration"}),"\n",(0,t.jsx)(n.p,{children:"The script automatically configures sign-in auto-acceleration, which allows users to skip the Microsoft Entra sign-in page and go directly to your federated identity provider's sign-in page. This improves the user experience for federated authentication."}),"\n",(0,t.jsx)(n.p,{children:"By default, the script will:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Create a Home Realm Discovery policy for auto-acceleration"}),"\n",(0,t.jsx)(n.li,{children:'Apply it to applications tagged with "VouchFederated"'}),"\n",(0,t.jsx)(n.li,{children:"If no tagged applications are found, apply it to common Microsoft 365 applications"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"To tag an application for auto-acceleration:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-powershell",children:'# Get the service principal ID of your application\n$appId = "your-application-id"\n# Add the VouchFederated tag\nUpdate-MgServicePrincipal -ServicePrincipalId $appId -Tags @("VouchFederated")\n'})}),"\n",(0,t.jsx)(n.h3,{id:"domain-verification",children:"Domain Verification"}),"\n",(0,t.jsx)(n.p,{children:"When the script prompts for domain verification:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Create the TXT DNS record shown in the output"}),"\n",(0,t.jsx)(n.li,{children:"Wait for DNS propagation"}),"\n",(0,t.jsx)(n.li,{children:"Confirm when the record is created"}),"\n",(0,t.jsx)(n.li,{children:"The script will attempt to verify the domain"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,t.jsx)(n.h3,{id:"incorrect-issuer--sign-uri",children:"Incorrect issuer / sign uri"}),"\n",(0,t.jsx)(n.p,{children:"If your environment configuration has an incorrect setup, i.e. the issuer / sign uri aren't matching the domain, you might encounter the following (totally irrelevant) error:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-powershell",children:'New-MgDomainFederationConfiguration_CreateExpanded: /home/stijn/Documents/code/vouch/vouch/backend/identity/iam/ms-entra/create-domain-federation.ps1:123\nLine |\n 123 |          New-MgDomainFederationConfiguration `\n     |          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\n     | Domain already has Federation Configuration set.  Status: 400 (BadRequest) ErrorCode: Request_BadRequest Date: 2025-04-01T09:52:50  Headers: Cache-Control                 : no-cache Vary                          : Accept-Encoding\n     | Strict-Transport-Security     : max-age=31536000 request-id                    : 32856efe-22b0-4540-9de4-c33d7e3e8377 client-request-id             : b282bd9c-516a-4692-a59c-5afb87b85863 x-ms-ags-diagnostic           : {"ServerInfo":{"DataCenter":"West\n     | Europe","Slice":"E","Ring":"5","ScaleUnit":"001","RoleInstance":"AM4PEPF00033F3A"}} x-ms-resource-unit            : 1 Date                          : Tue, 01 Apr 2025 09:52:49 GM\n'})}),"\n",(0,t.jsx)(n.p,{children:"In order to fix this problem, you have to:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Update your configuration to align the domain and issuer / sign uri"}),"\n",(0,t.jsxs)(n.li,{children:["Remove the existing domain from MS Entra:\na. You can do this either in the MS Entra Admin console: ",(0,t.jsx)(n.a,{href:"https://entra.microsoft.com/#view/Microsoft_AAD_IAM/DomainsManagementMenuBlade/~/CustomDomainNames",children:"https://entra.microsoft.com/#view/Microsoft_AAD_IAM/DomainsManagementMenuBlade/~/CustomDomainNames"}),"\nb. Or with PowerShell: ",(0,t.jsx)(n.code,{children:"Remove-MgDomain -Id <your-domain>"})]}),"\n",(0,t.jsx)(n.li,{children:"Re-run the script (and perform domain verification again)"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"authentication-issues",children:"Authentication Issues"}),"\n",(0,t.jsx)(n.p,{children:"If you encounter authentication issues:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Ensure you have the correct permissions in Microsoft Entra ID"}),"\n",(0,t.jsxs)(n.li,{children:["Try running ",(0,t.jsx)(n.code,{children:"Connect-MgGraph"})," manually to troubleshoot authentication"]}),"\n",(0,t.jsx)(n.li,{children:"Check that your tenant ID is correct in the configuration file"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>s});var r=i(96540);const t={},o=r.createContext(t);function a(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);